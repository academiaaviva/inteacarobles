<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Academia Aviva - Gesti√≥n</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { 
            --bg: #020617; --blue: #3b82f6; --glass: rgba(15, 23, 42, 0.9); --text: #f8fafc;
            --nored: #7f1d1d; --comp: #064e3b; --proc: #78350f;
        }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; padding: 20px; }
        
        /* Estilos de Estado para las filas */
        .status-no-respuesta { background-color: var(--nored) !important; }
        .status-completado { background-color: var(--comp) !important; }
        .status-proceso { background-color: var(--proc) !important; }
        .status-pendiente { background-color: transparent; }

        .toolbar { display: flex; gap: 10px; margin-bottom: 20px; background: var(--glass); padding: 15px; border-radius: 8px; border: 1px solid #1e293b; }
        .search-bar { flex-grow: 1; padding: 10px; background: #0f172a; border: 1px solid #1e293b; color: white; border-radius: 5px; }
        
        .btn { padding: 8px 15px; border: 1px solid var(--blue); background: transparent; color: white; cursor: pointer; border-radius: 5px; font-weight: bold; font-size: 0.8rem; }
        .btn:hover { background: var(--blue); }
        .btn-delete { border-color: #ef4444; color: #ef4444; }
        .btn-delete:hover { background: #ef4444; color: white; }

        .excel-container { background: var(--glass); border: 1px solid #1e293b; border-radius: 8px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { background: #1e293b; color: var(--blue); padding: 12px; text-align: left; text-transform: uppercase; font-size: 0.75rem; }
        td { padding: 10px; border-bottom: 1px solid #334155; border-right: 1px solid #334155; }

        select.status-select { background: #0f172a; color: white; border: 1px solid var(--blue); padding: 5px; border-radius: 4px; }

        /* Modales */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #0f172a; padding: 30px; border: 1px solid var(--blue); border-radius: 12px; width: 350px; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-size: 0.8rem; color: #94a3b8; }
        .input-group input, .input-group select { width: 100%; padding: 8px; background: #1e293b; border: 1px solid #334155; color: white; border-radius: 4px; box-sizing: border-box; }
    </style>
</head>
<body>

    <h2 style="color: var(--blue); letter-spacing: 2px;">GESTI√ìN DE INTERESADOS</h2>

    <div class="toolbar">
        <button class="btn" onclick="openAddModal()">+ A√±adir Interesado</button>
        <input type="text" id="searchInput" class="search-bar" placeholder="Buscar por nombre..." onkeyup="window.filterData()">
        <button class="btn" onclick="openPrintModal()">üìÑ Imprimir</button>
    </div>

    <div class="excel-container">
        <table id="mainTable">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Red Social</th>
                    <th>App</th>
                    <th>Fecha</th>
                    <th>Tel√©fono</th>
                    <th>Estado</th>
                    <th>Acci√≥n</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <div id="modalAdd" class="modal">
        <div class="modal-content">
            <h3>Nuevo Registro</h3>
            <div class="input-group"><label>Nombre</label><input type="text" id="fNombre"></div>
            <div class="input-group">
                <label>Red Social</label>
                <select id="fRed" onchange="document.getElementById('fOtra').style.display=(this.value=='Otro'?'block':'none')">
                    <option value="Facebook">Facebook</option>
                    <option value="Instagram">Instagram</option>
                    <option value="Otro">Otro</option>
                </select>
                <input type="text" id="fOtra" placeholder="¬øCu√°l?" style="display:none; margin-top:5px;">
            </div>
            <div class="input-group"><label>Fecha</label><input type="date" id="fFecha"></div>
            <div class="input-group"><label>Tel√©fono</label><input type="tel" id="fTel"></div>
            <button class="btn" style="width:100%" id="btnGuardar">Guardar Registro</button>
            <button class="btn" style="width:100%; margin-top:10px; border-color:red;" onclick="closeModal('modalAdd')">Cancelar</button>
        </div>
    </div>

    <div id="modalPrint" class="modal">
        <div class="modal-content">
            <h3>Rango de Impresi√≥n</h3>
            <div class="input-group"><label>Inicio</label><input type="date" id="pStart"></div>
            <div class="input-group"><label>Fin</label><input type="date" id="pEnd"></div>
            <button class="btn" style="width:100%" onclick="generatePDF()">Generar PDF</button>
            <button class="btn" style="width:100%; margin-top:10px;" onclick="closeModal('modalPrint')">Cerrar</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, updateDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBdR8vDblXMyKceO7vygMryy3bXIV4-PhU",
            authDomain: "academia-aviva-nic.firebaseapp.com",
            projectId: "academia-aviva-nic",
            storageBucket: "academia-aviva-nic.firebasestorage.app",
            messagingSenderId: "387193070830",
            appId: "1:387193070830:web:405aceb5d6fda212283fff"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let masterData = [];

        async function loadData() {
            const q = query(collection(db, "interesados"), orderBy("fecha", "desc"));
            const snapshot = await getDocs(q);
            masterData = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            renderTable(masterData);
        }

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";
            data.forEach(item => {
                const statusClass = item.estado ? `status-${item.estado.toLowerCase().replace(/ /g, '-')}` : '';
                const row = `<tr id="row-${item.id}" class="${statusClass}">
                    <td>${item.nombre}</td>
                    <td>${item.redSocial}</td>
                    <td>${item.otraApp || '-'}</td>
                    <td>${item.fecha}</td>
                    <td>${item.telefono}</td>
                    <td>
                        <select class="status-select" onchange="window.updateStatus('${item.id}', this.value)">
                            <option value="pendiente" ${item.estado=='pendiente'?'selected':''}>Pendiente</option>
                            <option value="no-respuesta" ${item.estado=='no-respuesta'?'selected':''}>No dio respuesta</option>
                            <option value="completado" ${item.estado=='completado'?'selected':''}>Completado</option>
                            <option value="proceso" ${item.estado=='proceso'?'selected':''}>En proceso</option>
                        </select>
                    </td>
                    <td>
                        <button class="btn btn-delete" onclick="window.deleteItem('${item.id}')">Eliminar</button>
                    </td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        // FUNCIONES GLOBALES
        window.updateStatus = async (id, value) => {
            const docRef = doc(db, "interesados", id);
            await updateDoc(docRef, { estado: value });
            loadData(); // Recargar para aplicar colores
        };

        window.deleteItem = async (id) => {
            if(confirm("¬øEst√°s seguro de eliminar este interesado?")) {
                await deleteDoc(doc(db, "interesados", id));
                loadData();
            }
        };

        document.getElementById('btnGuardar').onclick = async () => {
            const nuevo = {
                nombre: document.getElementById('fNombre').value,
                redSocial: document.getElementById('fRed').value,
                otraApp: document.getElementById('fOtra').value,
                fecha: document.getElementById('fFecha').value,
                telefono: document.getElementById('fTel').value,
                estado: 'pendiente'
            };
            if(!nuevo.nombre || !nuevo.fecha) return alert("Nombre y fecha requeridos");
            await addDoc(collection(db, "interesados"), nuevo);
            closeModal('modalAdd');
            loadData();
        };

        window.filterData = () => {
            const val = document.getElementById('searchInput').value.toLowerCase();
            const filtrados = masterData.filter(d => d.nombre.toLowerCase().includes(val));
            renderTable(filtrados);
        };

        loadData();
    </script>

    <script>
        function openAddModal() { 
            document.getElementById('modalAdd').style.display = 'flex'; 
            document.getElementById('fFecha').valueAsDate = new Date();
        }
        function openPrintModal() { document.getElementById('modalPrint').style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Reporte de Interesados - Academia Aviva", 14, 15);
            doc.autoTable({ html: '#mainTable', startY: 25, columns: [0,1,2,3,4,5] });
            doc.save('reporte_academia.pdf');
        }
    </script>
</body>
</html>
